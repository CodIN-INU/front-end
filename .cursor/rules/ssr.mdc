---
alwaysApply: true
---

---
description: Next.js App Router data fetching + caching/revalidate rules, segment config, server actions
globs:
  - "src/app/**/*"
  - "src/server/**/*"
  - "src/features/**/*"
alwaysApply: false
---

# Data Fetching / Caching / Revalidate Rules (App Router)

## 1) 서버 데이터 패칭 기본
- 초기 렌더에 필요한 데이터는 가능한 서버에서 fetch한다.
- 서버 fetch는 Next 확장(fetch cache/revalidate 의미가 프레임워크 캐시와 연결됨)을 이해하고 명시적으로 옵션을 선택한다.

## 2) 캐시/재검증은 “명시”가 원칙
- 라우트/요청 특성에 따라 아래 중 하나를 선택하고 이유를 주석/문서로 남긴다:
  - 강캐시(정적 성격): fetch에 cache 전략 명시(예: force-cache) 또는 revalidate 설정
  - 주기적 최신화: next.revalidate 또는 segment의 export const revalidate
  - 요청마다 최신: no-store / revalidate 0 / force-dynamic 등으로 동적 렌더링 강제

## 3) Route Segment Config 사용 규칙
- page.tsx / layout.tsx / route handler에서 export const ... 로 렌더링/캐시 동작을 제어할 수 있다.
- “왜 이 페이지가 dynamic인지/왜 revalidate인지”를 근거와 함께 남긴다.

## 4) Server Actions/Functions (Mutations)
- 폼/뮤테이션은 Server Action 우선 검토:
  - 입력 검증(스키마)
  - 권한 체크(세션/role)
  - 에러를 UI가 처리할 수 있는 형태로 매핑
- 서버 액션 파일/함수에는 use server를 사용하고, 클라이언트로 비밀값이 새지 않게 한다.

## 5) 흔한 SSR 전환 버그 예방
- 서버 렌더에서 Date.now/Math.random/locale formatting으로 UI 만들지 않는다(불가피하면 클라에서만 처리)
- 브라우저 API는 Client leaf로 격리한다
